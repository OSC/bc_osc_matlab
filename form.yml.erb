# Batch Connect app configuration file
#
# @note Used to define the submitted cluster, title, description, and
<%-
  cmd = "sinfo -o '%P|%g|%l|%G|%m|%c' --noheader"
  begin
    output, status = Open3.capture2e(cmd)
    if status.success?
      raw_data = output
    else
      raise output
    end
  rescue => e
    qos = []
    qerror = e.message.strip
  end

  begin
    output = Open3.pipeline_r("/usr/bin/sacctmgr show associations user=$USER -P -n format=account,qos", "grep -v expired", "awk -F '|' 'BEGIN { ORS=\",\" }; {print $1}'") {|o| p o.read }
    groups = output
  end
-%>

---

cluster: "quests"

form:
  # What version of R do you want to run
  - version
  - vnc_resolution
  - bc_vnc_resolution
  # This allows the user to select which partition they submit to
  - slurm_partition
  # This allows a user to request a GPU
  - gres_value
  # This allows a user to specify the account they are submitting under
  - slurm_account
  # This allows a user to use more than 1 core
  - num_cores
  # This checkbox is to encourage folks to consider before asking for more than 1 node
  - request_more_than_one_node
  # how many nodes do you want to request
  - number_of_nodes
  # This allows a user to request RAM
  - memory_per_node
  # How many hours do you want to run this job for
  - bc_num_hours
  # User can supply e-mail if they would like to be e-mailed when the session begins
  - user_email
  # Name of the Slurm job
  - job_name
  # these variables are for the JavaScript
  - raw_data
  - raw_group_data

attributes:
  version:
    widget: select
    label: "Matlab version"
    help: "This defines the version of Matlab you want to load."
    options:
      - [ "MATLAB-2018a", "matlab/r2018a" ]
      - [ "MATLAB-2018b", "matlab/r2018b" ]
      - [ "MATLAB-2020b", "matlab/r2020b" ]
      - [ "MATLAB-2021b", "matlab/r2021b" ]
      - [ "MATLAB-2022a", "matlab/r2022a" ]
      - [ "MATLAB-2022b", "matlab/r2022b" ]

  vnc_resolution:
    label: "Resolution"
    required: true
    widget: "select"
    value: "1280x1024"
    options:
      - ["2560x1600","2560x1600"]
      - ["2560x1440","2560x1440"]
      - ["1920x1200","1920x1200"]
      - ["1920x1080","1920x1080"] 
      - ["1600x1200","1600x1200"]
      - ["1280x1024","1280x1024"]
      - ["1280x960","1280x960"]  
      - ["1024x768","1024x768"]
      - ["800x600","800x600"]

  bc_vnc_resolution:
    required: true
    value: "1280x1024"

  job_name:
    label: "Name of the Job"
    value: "Matlab GUI"

  bc_num_hours:
    label: "Wall Clock Time"
    help: |
      The maximum number of hours the Jupyter sessions will run for. You can always terminate your jupyter session early, but it will automatically be terminated by Slurm once the walltime is hit.
    value: 1

  slurm_partition: 
    label: "SLURM Partition"
    help: |
      The SLURM partition you want to submit to. This selection will influence which accounts you can choose as some partition can only be submitted to through certain accounts.
    widget: select

  slurm_account:
    label: "SLURM Account/Project Name"
    help: |
      The SLURM account (i.e., the value of the -A or --account flag used when submitting a SLURM job).
    widget: select

  gres_value:
    label: "Type of GPU that you would like to request"
    help: |
      If you are submitting to `gengpu` the only option that you can select is `A100`.
    widget: select
    default: ""

  num_cores:
    widget: "number_field"
    label: "Number of CPUs/cores/processors"
    value: 1
    help: |
      Please note that you likely do not need to request more than a single CPU unless you know that your application can be parallelized and also please note that the more cores requested, the longer the wait for the session to start.
    min: 1
    max: 64
    step: 1
    id: 'num_cores'

  request_more_than_one_node:
    widget: "check_box"
    label: "Request more than a single node"
    help: |
      Only check this box if you are confident that your application of choice can utilize CPUs across
      more than one node. These applications/packages would include MPI4py, Dask, PySpark, etc.

  number_of_nodes:
    widget: "number_field"
    label: "Number of nodes being requested."
    value: 1
    help: |
      Number of nodes.
    min: 1
    step: 1
    id: 'number_of_nodes'
    help: |
      A reminder to check that your application of choice can utilize CPUs across
      more than one node. These applications/packages would include MPI4py, Dask, PySpark, etc.

  memory_per_node:
    widget: "number_field"
    label: "Total memory or RAM do you need in GB."
    value: 5
    help: |
      How much total memory/RAM do you need in GB.
    min: 1
    max: 243
    step: 1
    id: 'memory_per_node'

  user_email:
    label: "Email Address (Optional)"
    help: |
      Enter your email address if you would like to receive an email when the session starts. Leave blank for no email.

  raw_data:
    label: "Account associations for use by JavaScript"
    widget: hidden_field
    value: "<%= raw_data %>"
    cacheable: false

  raw_group_data:
    label: "linux groups for use by JavaScript"
    widget: hidden_field
    value: "<%= groups %>"
    cacheable: false
